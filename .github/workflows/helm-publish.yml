name: Helm Chart Package & Publish

on:
  push:
    branches: [ main ]
    paths:
      - 'charts/**'
      - 'values.yml'
      - 'ingress.yml'
      - '.github/workflows/helm-publish.yml'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  package-and-publish:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Helm
      uses: azure/setup-helm@v3
      with:
        version: 'latest'

    - name: Generate version
      id: version
      run: |
        VERSION="1.0.0"
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "date=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT

    - name: Update Chart.yaml
      run: |
        sed -i "s/version: .*/version: ${{ steps.version.outputs.version }}/" charts/RAG.io/Chart.yaml
        sed -i "s/appVersion: .*/appVersion: \"${{ steps.version.outputs.version }}\"/" charts/RAG.io/Chart.yaml
        sed -i "s|{{ github_username }}|${{ github.repository_owner }}|g" charts/RAG.io/Chart.yaml
        sed -i "s|{{ github_username }}|${{ github.repository_owner }}|g" charts/RAG.io/values.yaml
        cat charts/RAG.io/Chart.yaml

    - name: Lint Helm chart
      run: helm lint charts/RAG.io

    - name: Package Helm chart
      run: |
        mkdir -p charts
        helm package charts/RAG.io -d charts/
        ls -lah charts/

    - name: Create Helm index
      run: |
        if [ -f charts/index.yaml ]; then
          helm repo index charts/ --url https://${{ github.repository_owner }}.github.io/RAG.io/ --merge charts/index.yaml
        else
          helm repo index charts/ --url https://${{ github.repository_owner }}.github.io/RAG.io/
        fi
        cat charts/index.yaml

    - name: Create documentation
      run: |
        cat > charts/README.md << 'EOF'
        # RAG Multi-Expert Helm Charts
        
        Kubernetes deployment chart for RAG Multi-Expert System (Backend + Frontend + PostgreSQL + ChromaDB).
        
        ## Add Repository
        ```bash
        helm repo add rag https://${{ github.repository_owner }}.github.io/RAG.io/
        helm repo update
        ```
        
        ## Install Chart
        ```bash
        helm upgrade --install rag rag/rag-multi-expert \
          --namespace rag \
          --create-namespace \
          -f values.yml
          ```

        ## Values.yaml - StorageClass Auto Provisioning
        ```yaml
        # Default values for RAG Multi-Expert Helm chart
        nameOverride: ""
        fullnameOverride: ""

        replicaCount: 1

        # Container Registry
        registry: ghcr.io
        imagePullSecrets: []

        # Backend FastAPI configuration
        backend:
          enabled: true
          name: backend
          image:
            repository: ghcr.io/iwebbo/RAG.io/backend
            tag: "latest"
            pullPolicy: IfNotPresent
          
          replicas: 2
          
          service:
            type: ClusterIP
            port: 8000
            targetPort: 8000
          
          resources:
            requests:
              memory: "512Mi"
              cpu: "250m"
            limits:
              memory: "2Gi"
              cpu: "1000m"
          
          env:
            - name: LOG_LEVEL
              value: "INFO"
            - name: WORKERS
              value: "4"

        # Frontend Vue 3 configuration
        frontend:
          enabled: true
          name: frontend
          image:
            repository: ghcr.io/iwebbo/RAG.io/frontend
            tag: "latest"
            pullPolicy: IfNotPresent
          
          replicas: 2
          
          service:
            type: ClusterIP
            port: 80
            targetPort: 80
          
          resources:
            requests:
              memory: "128Mi"
              cpu: "50m"
            limits:
              memory: "256Mi"
              cpu: "250m"

        # PostgreSQL configuration
        postgres:
          enabled: true
          name: postgres
          image:
            repository: postgres
            tag: "15-alpine"
            pullPolicy: IfNotPresent
          
          service:
            type: ClusterIP
            port: 5432
            targetPort: 5432
          
          storage:
            enabled: true
            size: 10Gi
            className: local-path
            mountPath: /var/lib/postgresql/data
            subPath: postgres
          
          resources:
            requests:
              memory: "512Mi"
              cpu: "250m"
            limits:
              memory: "1Gi"
              cpu: "500m"
          
          database: rag_db
          user: raguser
          password: "changeMeRag123!"

        # ChromaDB Vector Store configuration
        chroma:
          enabled: true
          name: chroma
          image:
            repository: chromadb/chroma
            tag: "latest"
            pullPolicy: IfNotPresent
          
          service:
            type: ClusterIP
            port: 8001
            targetPort: 8000
          
          storage:
            enabled: true
            className: local-path
            size: 20Gi
            mountPath: /chroma/chroma
          
          resources:
            requests:
              memory: "1Gi"
              cpu: "500m"
            limits:
              memory: "4Gi"
              cpu: "2000m"

        # Shared document storage
        documents:
          storage:
            enabled: true
            className: local-path
            size: 50Gi
            mountPath: /app/data/documents

        secrets:
          create: true
          name: rag-secrets
          data:
            DATABASE_URL: "postgresql://raguser:changeMeRag123!@rag-multi-expert-postgres:5432/rag_db"
            POSTGRES_SERVER: "rag-multi-expert-postgres"
            POSTGRES_PORT: "5432"
            POSTGRES_DB: "rag_db"
            POSTGRES_USER: "raguser"
            POSTGRES_PASSWORD: "changeMeRag123!"
            CHROMA_HOST: "rag-multi-expert-chroma"
            CHROMA_PORT: "8001"
            SECRET_KEY: "changeMeSecretKeyForJWT123"
            ENCRYPTION_KEY: "changeMeEncryptionKey123="
            OLLAMA_URL: "http://ollama.default.svc.cluster.local:11434"
            OPENAI_API_KEY: ""
            ANTHROPIC_API_KEY: ""

        # Ingress configuration
        ingress:
          enabled: true
          className: "nginx"
          annotations:
            nginx.ingress.kubernetes.io/rewrite-target: /
            nginx.ingress.kubernetes.io/proxy-body-size: "100m"
            nginx.ingress.kubernetes.io/proxy-read-timeout: "600"
            nginx.ingress.kubernetes.io/proxy-send-timeout: "600"
          
          hosts:
            - host: rag.local
              paths:
                - path: /
                  pathType: Prefix
                  service: frontend
                  port: 80
                - path: /api
                  pathType: Prefix
                  service: backend
                  port: 8000
          
          tls:
            enabled: false

        # Service Account
        serviceAccount:
          create: true
          name: "rag-sa"

        # Pod Security
        podAnnotations: {}
        podSecurityContext:
          runAsNonRoot: true
          runAsUser: 1000
          fsGroup: 1000

        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
              - ALL

        # Node selection
        nodeSelector: {}
        tolerations: []
        affinity: {}
        ```
        
        ## Values to be changed with StorageClass manual + PVs
        ```yaml
        postgres:
          storage:
            enabled: true
            size: 10Gi
            className: local-storage  # Manual StorageClass

        chroma:
          storage:
            enabled: true
            size: 20Gi
            className: local-storage  # Manual StorageClass

        documents:
          storage:
            enabled: true
            size: 50Gi
            className: local-storage  # Manual StorageClass
        ```
        
        ## pv-postgres.yaml
        ```yaml
        apiVersion: v1
        kind: PersistentVolume
        metadata:
          name: rag-postgres-pv
        spec:
          storageClassName: local-storage
          capacity:
            storage: 10Gi
          accessModes:
            - ReadWriteOnce
          persistentVolumeReclaimPolicy: Retain
          hostPath:
            path: "/mnt/data/rag-postgres"
            type: DirectoryOrCreate
          nodeAffinity:
            required:
              nodeSelectorTerms:
              - matchExpressions:
                - key: kubernetes.io/hostname
                  operator: In
                  values:
                  - k8s-prod-worker-01
          ```

        ## pv-chroma.yaml
        ```yaml
        apiVersion: v1
        kind: PersistentVolume
        metadata:
          name: rag-chroma-pv
        spec:
          storageClassName: local-storage
          capacity:
            storage: 20Gi
          accessModes:
            - ReadWriteOnce
          persistentVolumeReclaimPolicy: Retain
          hostPath:
            path: "/mnt/data/rag-chroma"
            type: DirectoryOrCreate
          nodeAffinity:
            required:
              nodeSelectorTerms:
              - matchExpressions:
                - key: kubernetes.io/hostname
                  operator: In
                  values:
                  - k8s-prod-worker-01
        ```

        ## pv-documents.yaml
        ```yaml
        apiVersion: v1
        kind: PersistentVolume
        metadata:
          name: rag-documents-pv
        spec:
          storageClassName: local-storage
          capacity:
            storage: 50Gi
          accessModes:
            - ReadWriteMany
          persistentVolumeReclaimPolicy: Retain
          hostPath:
            path: "/mnt/data/rag-documents"
            type: DirectoryOrCreate
          nodeAffinity:
            required:
              nodeSelectorTerms:
              - matchExpressions:
                - key: kubernetes.io/hostname
                  operator: In
                  values:
                  - k8s-prod-worker-01
        ```

        ## Apply PVs
        ```shell
        kubectl apply -f pv-postgres.yaml
        kubectl apply -f pv-chroma.yaml
        kubectl apply -f pv-documents.yaml
        # AVANT HELM UPGRADE/INSTALL (crÃ©er PVCs pour hÃ©berger DB/Vector Store/Documents)
        ```

        ## Prerequisites
        
        - Kubernetes 1.20+
        - Helm 3.0+
        - Ingress Controller (nginx-ingress)
        - StorageClass configured (local-path or local-storage)
        
        ## Configuration Files (at repo root)
        
        - `values.yml` - Helm values (mandatory)
        - `ingress.yml` - Ingress configuration (optional)
        
        ## Deploy with Generic Ansible Pipeline
        ```bash
        ansible-playbook deploy_helm_generic.yml 

        use: https://github.com/iwebbo/Ansible/tree/main/roles/deploy_helmchart_stack_standalone
        ```
        
        ## Chart Values
        
        | Parameter | Description | Default |
        |-----------|-------------|---------|
        | `backend.replicas` | Backend replicas | 2 |
        | `frontend.replicas` | Frontend replicas | 2 |
        | `backend.image.tag` | Backend image tag | latest |
        | `frontend.image.tag` | Frontend image tag | latest |
        | `postgres.storage.size` | PostgreSQL volume size | 10Gi |
        | `chroma.storage.size` | ChromaDB volume size | 20Gi |
        | `documents.storage.size` | Documents volume size | 50Gi |
        | `ingress.enabled` | Enable Ingress | true |
        
        ## Architecture
        ```
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚              Ingress (Nginx)                    â”‚
        â”‚  rag.local â†’ Frontend (/) + Backend (/api)      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   Frontend (Vue 3)    â”‚  â”‚  Backend (FastAPI) â”‚
        â”‚   Port: 80            â”‚  â”‚  Port: 8000        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                      â”‚                      â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  PostgreSQL         â”‚ â”‚  ChromaDB         â”‚ â”‚  Documents (PVC)   â”‚
        â”‚  Port: 5432         â”‚ â”‚  Port: 8001       â”‚ â”‚  Shared Storage    â”‚
        â”‚  PVC: 10Gi          â”‚ â”‚  PVC: 20Gi        â”‚ â”‚  PVC: 50Gi         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        ```
        
        ## Build & Push Flow
        
        1. Push to `backend/**` â†’ GitHub Actions builds and pushes to `ghcr.io`
        2. Push to `frontend/**` â†’ GitHub Actions builds and pushes to `ghcr.io`
        3. Push to `charts/**` â†’ GitHub Actions packages and publishes chart
        
        ## Verification
        ```bash
        # List charts
        helm search repo rag
        
        # Get values
        helm show values rag/rag-multi-expert
        
        # Dry run
        helm install rag rag/rag-multi-expert --dry-run --debug
        
        # Check deployments
        kubectl get pods -n rag
        kubectl get svc -n rag
        kubectl get pvc -n rag
        kubectl get ingress -n rag
        ```

        ## LLM Configuration

        LLM providers are configured via the UI after deployment. The application supports:
        - Ollama (local)
        - OpenAI API
        - Anthropic Claude API

        Set API keys in the application settings or override secrets in `values.yml`.

        ## Domain Experts

        The system includes 4 domain experts configurable via UI:
        - ðŸ”§ DevOps Expert
        - âš–ï¸ Legal Expert
        - ðŸ‘¥ HR Expert
        - ðŸ’° Finance Expert

        Documents for each domain should be uploaded via the web interface.
        EOF
        cat charts/README.md

    - name: Checkout gh-pages branch
      uses: actions/checkout@v4
      with:
        ref: gh-pages
        path: gh-pages
        fetch-depth: 0

    - name: Copy charts to gh-pages
      run: |
        mkdir -p gh-pages
        cp -r charts/* gh-pages/
        ls -lah gh-pages/

    - name: Commit and push to gh-pages
      run: |
        cd gh-pages
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add .
        git commit -m "Publishing Helm chart ${{ steps.version.outputs.version }}" || true
        git push origin gh-pages
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Create deployment summary
      run: |
        echo "## ðŸ“¦ Helm Chart Published" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Chart Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ Repository URL" >> $GITHUB_STEP_SUMMARY
        echo "https://${{ github.repository_owner }}.github.io/RAG.io/" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¥ Add Repository" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo "helm repo add rag https://${{ github.repository_owner }}.github.io/RAG.io/" >> $GITHUB_STEP_SUMMARY
        echo "helm repo update" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸš€ Install" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo "helm install rag rag/rag-multi-expert -n rag --create-namespace -f values.yml" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY